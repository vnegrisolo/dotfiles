#!/bin/bash

folder="$1"

function help {
  echo -e "Usage:"
  echo -e "\t$0 <folder>"
  echo -e ""
  echo -e "You will need:"
  echo -e "\t- brew install guetzli"
  echo -e "\t- brew install gifsicle"
  echo -e "\t- brew install pngquant"
  echo -e "\t- npm install -g svgo"
}

function compare_images {
  old_file="$1"
  new_file="$2"
  threshold=20

  old_size=`ls -lan ${old_file} | awk '{print $5}'`
  new_size=`ls -lan ${new_file} | awk '{print $5}'`
  improvement=$((100 * ($old_size - $new_size) / $old_size))

  if [[ $improvement -ge $threshold ]]; then
    echo -e "$old_size\t$new_size\t-$improvement%\t${old_file}"
  else
    echo -e "[DONT CARE] => $old_size\t$new_size\t-$improvement%\t${old_file}"
    rm $new_file
  fi
}

function compact_images_by_type {
  type="$1"
  for old_file in $(find $folder -type f | grep -i "\.${type}$"); do
    new_file="${old_file%????}-REDUCED.${type}"
    case "$1" in
      png) pngquant $old_file -o $new_file ;;
      gif) gifsicle --colors 256 -i < $old_file > $new_file ;;
      svg) (svgo $old_file -o $new_file) > /dev/null ;;
      *)   guetzli $old_file $new_file ;;
    esac
    compare_images "$old_file" "$new_file"
  done
}

if (($# < 1 || $# > 1)); then echo "[ERROR] `help`"; exit -1; fi

for type in jpg png gif svg; do
  echo "type=${type}"
  compact_images_by_type "$type"
done

exit 0
